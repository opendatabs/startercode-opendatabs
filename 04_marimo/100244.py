# /// script
# requires-python = ">=3.12"
# dependencies = [
#     "marimo",
#     "matplotlib==3.10.6",
#     "missingno==0.5.2",
#     "pandas==2.3.2",
#     "polars==1.32.3",
#     "requests==2.32.5",
# ]
# ///

import marimo

__generated_with = "0.15.1"
app = marimo.App(auto_download=["html"])


@app.cell
def _():
    import marimo as mo
    return (mo,)


@app.cell(hide_code=True)
def _(mo):
    mo.md(
        r"""
    ## Open Government Data, provided by **Statistisches Amt des Kantons Basel-Stadt - DCC Data Competence Center**
    *Autogenerated Python starter code for dataset with identifier* **100244**
    """
    )
    return


@app.cell
def _(mo):
    mo.md(
        r"""
    ## Dataset
    # **Gefahrenstufen für Hochwasser**
    **Description**: <p style='margin-bottom: 11px; font-size: 1.1em; line-height: 1.5; color: rgb(69, 69, 69); font-family: "Frutiger Neue Regular", Arial, sans-serif;'><span style='font-family: "Frutiger Neue Bold", Arial, sans-serif; font-size: 15.4px;'>Entsprechend den Bestimmungen der Alarmierungsverordnung verwendet das BAFU für die Warnung vor Hochwasser eine fünfstufige Gefahrenskala. Die Gefahrenstufen geben Auskunft über die Intensität des Ereignisses, die möglichen Auswirkungen und Verhaltensempfehlungen.</span><br></p><p style='margin-bottom: 11px; font-size: 1.1em; line-height: 1.5; color: rgb(69, 69, 69); font-family: "Frutiger Neue Regular", Arial, sans-serif;'>Die Schwellenwerte, die die Gefahrenstufen abgrenzen, werden ausgehend vom vorhandenen Wissen über das Verhalten des jeweiligen Fliessgewässers festgelegt (Pegel, ab dem das Gewässer über die Ufer tritt, ab dem erste Schäden eintreten usw.). Diese Schwellenwerte entsprechen in etwa der Jährlichkeit von Hochwasserereignissen, also einer Wiederkehrperiode von durchschnittlich 2, 10, 30 oder 100 Jahren.</p><ul style='line-height: 1.5; margin: 1.5em 0px 0px; padding: 0px 0px 0px 0.4em; list-style-type: square; color: rgb(69, 69, 69); font-family: "Frutiger Neue Regular", Arial, sans-serif;'><li style="font-size: 1.1em; line-height: 1.5; margin-left: 0.8em;">Die <span style='font-family: "Frutiger Neue Bold", Arial, sans-serif;'>Gefahrenstufe 1 </span>entspricht ungefähr einer Abflussmenge, die unter dem Wert liegt, der im Durchschnitt einmal in 2 Jahren erreicht wird.</li><li style="font-size: 1.1em; line-height: 1.5; margin-left: 0.8em;">Die <span style='font-family: "Frutiger Neue Bold", Arial, sans-serif;'>Gefahrenstufe 2 </span>entspricht ungefähr einer Abflussmenge, die durchschnittlich einmal innerhalb von 2 bis 10 Jahren auftritt.</li><li style="font-size: 1.1em; line-height: 1.5; margin-left: 0.8em;">Die <span style='font-family: "Frutiger Neue Bold", Arial, sans-serif;'>Gefahrenstufe 3 </span>entspricht ungefähr einer Abflussmenge, die im Durchschnitt einmal innerhalb von 10 bis 30 Jahren auftritt.</li><li style="font-size: 1.1em; line-height: 1.5; margin-left: 0.8em;">Die <span style='font-family: "Frutiger Neue Bold", Arial, sans-serif;'>Gefahrenstufe 4 </span>entspricht ungefähr einer Abflussmenge, die im Durchschnitt einmal innerhalb von 30 bis 100 Jahren auftritt.</li><li style="font-size: 1.1em; line-height: 1.5; margin-left: 0.8em;">Die <span style='font-family: "Frutiger Neue Bold", Arial, sans-serif;'>Gefahrenstufe 5 </span>entspricht ungefähr einer Abflussmenge, die im Durchschnitt höchstens einmal in 100 Jahren auftritt.</li></ul><p style="font-size: 1.1em; line-height: 1.5; margin-left: 0.8em;"><br></p><p style="line-height: 1.5; margin-left: 0.8em;"><span style="font-size: 15.4px;">Für weitere Informationen siehe </span><a href="https://www.hydrodaten.admin.ch/de/die-5-gefahrenstufen-fuer-hochwasser" target="_blank">https://www.hydrodaten.admin.ch/de/die-5-gefahrenstufen-fuer-hochwasser</a><span style="font-size: 15.4px;"> </span><br></p>

    *You can find the dataset [under this link](https://data.bs.ch/explore/dataset/100244)*.
    """
    )
    return


@app.cell(hide_code=True)
def _(mo):
    mo.md(
        r"""
    /// details | Metadata

    - **Dataset_identifier** `100244`
- **Title** `Gefahrenstufen für Hochwasser`
- **Description** `<p style='margin-bottom: 11px; font-size: 1.1em; line-height: 1.5; color: rgb(69, 69, 69); font-family: "Frutiger Neue Regular", Arial, sans-serif;'><span style='font-family: "Frutiger Neue Bold", Arial, sans-serif; font-size: 15.4px;'>Entsprechend den Bestimmungen der Alarmierungsverordnung verwendet das BAFU für die Warnung vor Hochwasser eine fünfstufige Gefahrenskala. Die Gefahrenstufen geben Auskunft über die Intensität des Ereignisses, die möglichen Auswirkungen und Verhaltensempfehlungen.</span><br></p><p style='margin-bottom: 11px; font-size: 1.1em; line-height: 1.5; color: rgb(69, 69, 69); font-family: "Frutiger Neue Regular", Arial, sans-serif;'>Die Schwellenwerte, die die Gefahrenstufen abgrenzen, werden ausgehend vom vorhandenen Wissen über das Verhalten des jeweiligen Fliessgewässers festgelegt (Pegel, ab dem das Gewässer über die Ufer tritt, ab dem erste Schäden eintreten usw.). Diese Schwellenwerte entsprechen in etwa der Jährlichkeit von Hochwasserereignissen, also einer Wiederkehrperiode von durchschnittlich 2, 10, 30 oder 100 Jahren.</p><ul style='line-height: 1.5; margin: 1.5em 0px 0px; padding: 0px 0px 0px 0.4em; list-style-type: square; color: rgb(69, 69, 69); font-family: "Frutiger Neue Regular", Arial, sans-serif;'><li style="font-size: 1.1em; line-height: 1.5; margin-left: 0.8em;">Die <span style='font-family: "Frutiger Neue Bold", Arial, sans-serif;'>Gefahrenstufe 1 </span>entspricht ungefähr einer Abflussmenge, die unter dem Wert liegt, der im Durchschnitt einmal in 2 Jahren erreicht wird.</li><li style="font-size: 1.1em; line-height: 1.5; margin-left: 0.8em;">Die <span style='font-family: "Frutiger Neue Bold", Arial, sans-serif;'>Gefahrenstufe 2 </span>entspricht ungefähr einer Abflussmenge, die durchschnittlich einmal innerhalb von 2 bis 10 Jahren auftritt.</li><li style="font-size: 1.1em; line-height: 1.5; margin-left: 0.8em;">Die <span style='font-family: "Frutiger Neue Bold", Arial, sans-serif;'>Gefahrenstufe 3 </span>entspricht ungefähr einer Abflussmenge, die im Durchschnitt einmal innerhalb von 10 bis 30 Jahren auftritt.</li><li style="font-size: 1.1em; line-height: 1.5; margin-left: 0.8em;">Die <span style='font-family: "Frutiger Neue Bold", Arial, sans-serif;'>Gefahrenstufe 4 </span>entspricht ungefähr einer Abflussmenge, die im Durchschnitt einmal innerhalb von 30 bis 100 Jahren auftritt.</li><li style="font-size: 1.1em; line-height: 1.5; margin-left: 0.8em;">Die <span style='font-family: "Frutiger Neue Bold", Arial, sans-serif;'>Gefahrenstufe 5 </span>entspricht ungefähr einer Abflussmenge, die im Durchschnitt höchstens einmal in 100 Jahren auftritt.</li></ul><p style="font-size: 1.1em; line-height: 1.5; margin-left: 0.8em;"><br></p><p style="line-height: 1.5; margin-left: 0.8em;"><span style="font-size: 15.4px;">Für weitere Informationen siehe </span><a href="https://www.hydrodaten.admin.ch/de/die-5-gefahrenstufen-fuer-hochwasser" target="_blank">https://www.hydrodaten.admin.ch/de/die-5-gefahrenstufen-fuer-hochwasser</a><span style="font-size: 15.4px;"> </span><br></p>`
- **Contact_name** `Open Data Basel-Stadt`
- **Issued** `2023-01-25`
- **Modified** `2022-12-16T12:54:26+00:00`
- **Rights** `NonCommercialAllowed-CommercialAllowed-ReferenceNotRequired`
- **Temporal_coverage_start_date** `None`
- **Temporal_coverage_end_date** `None`
- **Themes** `['Raum und Umwelt']`
- **Keywords** `['Rhein', 'Birs', 'Wiese', 'Pegel', 'Wasserstand', 'Abflussmenge', 'Strömung', 'Wasser']`
- **Publisher** `Bundesamt für Umwelt BAFU`
- **Reference** `None`


    ///
    """
    )
    return


@app.cell
def _():
    import os
    import pandas as pd
    import requests
    import matplotlib.pyplot as plt
    return os, pd, plt, requests


@app.cell
def _(plt):
    plt.style.use("ggplot")

    params = {
        "text.color": (0.25, 0.25, 0.25),
        "figure.figsize": [18, 6],
    }

    plt.rcParams.update(params)
    return


@app.cell
def _(os, pd, requests):
    def get_dataset(dataset_id):
        url = f"https://data.bs.ch/api/explore/v2.1/catalog/datasets/{dataset_id}/exports/csv
        r = requests.get(
            url, 
            params={
                "timezone": "Europe%2FZurich",
                "use_labels": "true"
            }
        )
        data_path = os.path.join(os.getcwd(), "..", "data")
        if not os.path.exists(data_path):
            os.makedirs(data_path)
        csv_path = os.path.join(data_path, f"{dataset_id}.csv")
        with open(csv_path, "wb") as f:
            f.write(r.content)
        data = pd.read_csv(
            url, sep=";", on_bad_lines="warn", encoding_errors="ignore", low_memory=False
        )
        # if dataframe only has one column or less the data is not ";" separated
        if data.shape[1] <= 1:
            print(
                "The data wasn't imported properly. Very likely the correct separator couldn't be found.\nPlease check the dataset manually and adjust the code."
            )
        return data
    return (get_dataset,)


@app.cell(hide_code=True)
def _(mo):
    mo.md(r"""## Load data""")
    return


@app.cell
def _(get_dataset):
    # Read the dataset
    df = get_dataset(dataset_id="100244")
    df
    return (df,)


@app.cell
def _(mo):
    mo.md(r"""## Analyze Data""")
    return


@app.cell
def _(df):
    # check missing values with missingno
    # https://github.com/ResidentMario/missingno
    import missingno as msno

    msno.matrix(df, labels=True, sort="descending")
    return


@app.cell
def _(df):
    df.info(memory_usage="deep", verbose=True)
    return


@app.cell
def _(df, pd, plt):
    # plot a histogram for each numerical feature
    try:
        df.hist(bins=25, rwidth=0.9)
        plt.tight_layout()
        plt.show()
    except pd.errors.DataError:
        print("No numerical data to plot.")
    return

@app.cell
def _(mo):
    mo.md(r"""**Questions about the data?** Open Data Basel-Stadt | opendata@bs.ch""")
    return

if __name__ == "__main__":
    app.run()
